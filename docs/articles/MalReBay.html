<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>MalReBay • MalReBay</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="MalReBay">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MalReBay</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/MalReBay.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SwissTPH/MalReBay/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>MalReBay</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SwissTPH/MalReBay/blob/HEAD/vignettes/MalReBay.Rmd" class="external-link"><code>vignettes/MalReBay.Rmd</code></a></small>
      <div class="d-none name"><code>MalReBay.Rmd</code></div>
    </div>

    
    
<style>
p.caption {
font-size: 0.85em;
font-style: italic;
color: grey
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>MalReBay</code> package is designed to determine whether a
recurrent malaria infection is a <strong>recrudescence</strong> (a
relapse of the original infection) or a <strong>reinfection</strong> (a
new infection from a separate mosquito bite). It uses a Bayesian MCMC
(Markov chain Monte Carlo) framework to analyze paired genotyping data
from a patient’s initial infection (Day 0) and their subsequent day of
recurrence (Day X).</p>
<p>This tutorial provides a step-by-step guide to the main analysis
workflow, from loading your data to interpreting the final results. We
will first review the conceptual framework of the package and then walk
through a practical example, from loading data to interpreting the final
results.</p>
</div>
<div class="section level2">
<h2 id="the-malrebay-conceptual-workflow">2. The MalReBay Conceptual Workflow<a class="anchor" aria-label="anchor" href="#the-malrebay-conceptual-workflow"></a>
</h2>
<p>Here we will have the conceptual steps that <code>MalReBay</code>
takes to get from your raw data to the final classification. The main
<code><a href="../reference/classify_infections.html">classify_infections()</a></code> function automates this entire
pipeline for you.</p>
<div class="float">
<img src="figure/MalReBay_Framework.png" width="600" alt="MalReBay Framework"><div class="figcaption">MalReBay Framework</div>
</div>
<p>The workflow consists of three main stages:</p>
<div class="section level4">
<h4 id="data-processing">Data Processing<a class="anchor" aria-label="anchor" href="#data-processing"></a>
</h4>
<p>This initial stage is a sequential pipeline designed to prepare your
data for analysis.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Import Data</strong>: The process begins with
<code>import_data()</code>, which reads your Excel file, automatically
detects the data type (length-polymorphic vs. amplicon sequencing), and
performs initial cleaning.</p></li>
<li><p><strong>Define Alleles</strong>: For length-polymorphic data,
<code>define_alleles()</code> groups raw fragment lengths into discrete,
well-defined allele bins.</p></li>
<li><p><strong>Calculate Frequencies</strong>:
<code>calculate_frequencies3()</code> computes the initial
population-level frequency of each allele, which provides a starting
point for the MCMC model.</p></li>
<li><p><strong>Recode Alleles</strong>: Finally,
<code>recode_alleles()</code> converts the raw allele measurements into
integer-based codes corresponding to the defined bins.</p></li>
</ol>
<p>The output of this stage is a clean, structured dataset ready for the
Bayesian engine.</p>
</div>
<div class="section level4">
<h4 id="the-bayesian-mcmc-algorithm">The Bayesian MCMC Algorithm<a class="anchor" aria-label="anchor" href="#the-bayesian-mcmc-algorithm"></a>
</h4>
<p>This is the core of the package. It uses a Gibbs sampling approach to
iteratively explore the probability space and find the most likely
classification for each patient.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Coordination</strong>: The <code>run_all_sites()</code>
function manages the analysis for each geographical site. For each site,
it calls the MCMC engine (<code>run_one_chain()</code> or
<code>run_one_chain_ampseq()</code>).</p></li>
<li>
<p><strong>Iteration</strong>: The engine runs for many iterations,
and in each step, it updates its estimates for:</p>
<ul>
<li>The identity of unobserved (“hidden”) alleles using
<code>switch_hidden_length()</code> or
<code>switch_hidden_ampseq()</code>.</li>
<li>The population-level allele frequencies using
<code>findposteriorfrequencies()</code>.</li>
</ul>
</li>
<li><p><strong>Convergence</strong>: The simulation runs in parallel
across multiple chains and automatically checks for convergence,
ensuring the results are stable and reliable.</p></li>
</ol>
</div>
<div class="section level4">
<h4 id="summarization-and-output">Summarization and Output<a class="anchor" aria-label="anchor" href="#summarization-and-output"></a>
</h4>
<p>Once the MCMC has converged, the package summarizes the vast amount
of data generated during the simulation into user-friendly outputs.</p>
<ul>
<li><p><strong>Posterior Probabilities</strong>: The primary output is a
table of posterior probabilities of recrudescence for each
patient.</p></li>
<li><p><strong>Diagnostic Reports</strong>: The
<code>generate_likelihood_diagnostics()</code> function creates plots
(traceplots, Gelman-Rubin plots) to verify model convergence.</p></li>
<li><p><strong>Allele Frequency Plots</strong>: The
<code><a href="../reference/generate_allele_frequency_plot.html">generate_allele_frequency_plot()</a></code> utility can be used to
visualize the raw allele distributions.</p></li>
<li><p><strong>Marker-Level Analysis</strong>: A detailed table is
generated showing the contribution of each genetic marker to the final
classification.</p></li>
</ul>
<p>Here we will walk through a practical example of using the
<code>MalReBay</code> package to classify recurrent malaria infections.
This example will demonstrate how to set up the analysis, run the MCMC
simulation, and interpret the results.</p>
</div>
</div>
<div class="section level2">
<h2 id="setup">1. Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, we need to load the <code>MalReBay</code> package, along with
a couple of other useful packages for data handling and plotting.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SwissTPH/MalReBay" class="external-link">MalReBay</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-input-data">2. The Input Data<a class="anchor" aria-label="anchor" href="#the-input-data"></a>
</h2>
<p>The main input for MalReBay is an Excel file with genotyping data. It
should include patient ID, sampling day, Day 0, Day of recurrence,
site/region, and allele calls for each marker. If site information is
missing, add it before analysis. While the first three columns are
recommended, the code also accepts data where patient ID and sampling
day are combined into one column. Including Day 0 samples from patients
without recurrence is optional but helpful, as it improves estimation of
allele frequencies and increases classification accuracy.</p>
<p>The package includes an example dataset from Angola that we will use
for this tutorial.</p>
<p>The <code><a href="../reference/classify_infections.html">classify_infections()</a></code> function expects this data to
be in a ‘wide’ format, where: * There is a <code>Sample.ID</code> column
that uniquely identifies each sample and includes “Day 0” or “Day
Failure”. * There is a <code>Site</code> column indicating the
geographical origin. * Allele calls for each marker are in columns named
like <code>LocusName_AlleleNumber</code> (e.g., <code>TA40_1</code>,
<code>TA40_2</code>, etc.).</p>
<p>Let’s get the file path to the example data included with the
package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This command finds the example file within the installed MalReBay package</span></span>
<span><span class="va">input_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Angola_2021_TES_7NMS.xlsx"</span>,</span>
<span>                          package <span class="op">=</span> <span class="st">"MalReBay"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">input_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C:/Users/golumo/AppData/Local/R/win-library/4.5/MalReBay/extdata/Angola_2021_TES_7NMS.xlsx"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-the-analysis">3. Running the Analysis<a class="anchor" aria-label="anchor" href="#running-the-analysis"></a>
</h2>
<p>The entire workflow is managed by the main function
<code><a href="../reference/classify_infections.html">classify_infections()</a></code>. This function requires three main
arguments:</p>
<ol style="list-style-type: decimal">
<li>
<code>input_filepath</code>: The path to your Excel data.</li>
<li>
<code>mcmc_config</code>: A list of settings for the MCMC
simulation.</li>
<li>
<code>output_folder</code>: A directory where results and diagnostic
plots will be saved.</li>
</ol>
<div class="section level3">
<h3 id="step-3-1-define-mcmc-configuration">Step 3.1: Define MCMC Configuration<a class="anchor" aria-label="anchor" href="#step-3-1-define-mcmc-configuration"></a>
</h3>
<p>For this example, we will use a minimal configuration for a quick
run. <strong>For a real analysis, you should consider using much larger
values for <code>chunk_size</code> and <code>max_iterations</code> and
increase or reduce the number of chains to ensure the model converges
properly.</strong> Please note running multiple chains (typically 3–4)
is recommended as it allows you to check whether all chains converge to
the same posterior distribution.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NOTE: These settings are for a quick demonstration only.</span></span>
<span><span class="va">quick_mcmc_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  n_chains <span class="op">=</span> <span class="fl">2</span>,          <span class="co"># Run two parallel chains</span></span>
<span>  chunk_size <span class="op">=</span> <span class="fl">1000</span>,       <span class="co"># Check convergence every 1000 iterations</span></span>
<span>  max_iterations <span class="op">=</span> <span class="fl">1000</span>,   <span class="co"># Stop after a maximum of 1000 total iterations</span></span>
<span>  rhat_threshold <span class="op">=</span> <span class="fl">1.1</span>,  <span class="co"># A relaxed convergence threshold for the example</span></span>
<span>  ess_threshold <span class="op">=</span> <span class="fl">50</span>     <span class="co"># A relaxed effective sample size for the example</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-2-define-an-output-folder">Step 3.2: Define an Output Folder<a class="anchor" aria-label="anchor" href="#step-3-2-define-an-output-folder"></a>
</h3>
<p>It’s good practice to save results to a dedicated folder. For this
tutorial, we’ll create a temporary directory.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"MalReBay_tutorial_results"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">output_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C:\\Users\\golumo\\AppData\\Local\\Temp\\Rtmpo7gvyS/MalReBay_tutorial_results"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-3-execute-the-main-function">Step 3.3: Execute the Main Function<a class="anchor" aria-label="anchor" href="#step-3-3-execute-the-main-function"></a>
</h3>
<p>Now we can run the analysis. <code><a href="../reference/classify_infections.html">classify_infections()</a></code> will
print progress messages to the console, informing you about the data
type it detected, the sites it is analyzing, and the status of the MCMC
convergence. The ‘future’ package is used in the background for parallel
processing, so you can expect the analysis to run faster on multi-core
machines.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">classification_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/classify_infections.html">classify_infections</a></span><span class="op">(</span></span>
<span>  input_filepath <span class="op">=</span> <span class="va">input_file</span>,</span>
<span>  mcmc_config <span class="op">=</span> <span class="va">quick_mcmc_config</span>,</span>
<span>  output_folder <span class="op">=</span> <span class="va">output_dir</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; INFO: Detected 'length_polymorphic' data format.</span></span>
<span><span class="co">#&gt; INFO: Following length-polymorphic data processing pipeline.</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in classify_infections(input_filepath = input_file, mcmc_config =</span></span>
<span><span class="co">#&gt; quick_mcmc_config, : The following requested markers were NOT found and will be</span></span>
<span><span class="co">#&gt; ignored: PolyA, TA42, TA81, TA87, TA40, ARAII, PFG377, TA60, K1, 3D7, MAD20,</span></span>
<span><span class="co">#&gt; RO33, R033, FC27, IC, glurp</span></span>
<span><span class="co">#&gt; Proceeding with analysis for these markers: 313, 383, TA1, POLYA, PFPK2, 2490, TA109</span></span>
<span><span class="co">#&gt; The model is running MCMC analysis...</span></span>
<span><span class="co">#&gt; Number of patient pairs (nids) found: 19</span></span>
<span><span class="co">#&gt; INFO: Preparing LENGTH-POLYMORPHIC MCMC engine for site: Benguela</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 4 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Generating convergence diagnostics for site: Benguela </span></span>
<span><span class="co">#&gt; Gelman-Rubin R-hat for Log-Likelihood:</span></span>
<span><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; loglikelihood       1.08       1.28</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Effective Sample Size (ESS):</span></span>
<span><span class="co">#&gt; loglikelihood </span></span>
<span><span class="co">#&gt;      163.9257</span></span>
<span><span class="co">#&gt; Number of patient pairs (nids) found: 13</span></span>
<span><span class="co">#&gt; INFO: Preparing LENGTH-POLYMORPHIC MCMC engine for site: Lunda Sul</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 4 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Generating convergence diagnostics for site: Lunda Sul </span></span>
<span><span class="co">#&gt; Gelman-Rubin R-hat for Log-Likelihood:</span></span>
<span><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; loglikelihood       1.31       2.05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Effective Sample Size (ESS):</span></span>
<span><span class="co">#&gt; loglikelihood </span></span>
<span><span class="co">#&gt;      33.81928</span></span>
<span><span class="co">#&gt; Number of patient pairs (nids) found: 38</span></span>
<span><span class="co">#&gt; INFO: Preparing LENGTH-POLYMORPHIC MCMC engine for site: Zaire</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 4 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 3 columns for this locus.</span></span>
<span><span class="co">#&gt;     -&gt; Binning method is: microsatellite</span></span>
<span><span class="co">#&gt;     -&gt; Found 5 columns for this locus.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Generating convergence diagnostics for site: Zaire </span></span>
<span><span class="co">#&gt; Gelman-Rubin R-hat for Log-Likelihood:</span></span>
<span><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; loglikelihood       1.09       1.36</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Effective Sample Size (ESS):</span></span>
<span><span class="co">#&gt; loglikelihood </span></span>
<span><span class="co">#&gt;      114.7537</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --- Debug: Structure of MCMC results ---</span></span>
<span><span class="co">#&gt; List of 6</span></span>
<span><span class="co">#&gt;  $ classifications:List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela : num [1:19, 1:150] 0 0 1 1 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul: num [1:13, 1:150] 0 1 0 0 0 0 1 1 0 0 ...</span></span>
<span><span class="co">#&gt;   ..$ Zaire    : num [1:38, 1:150] 1 0 0 0 0 0 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ ids            :List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela : chr [1:19] "BD21-002" "BD21-040" "BD21-041" "BD21-053" ...</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul: chr [1:13] "LL21-008" "LL21-010" "LL21-027" "LL21-037" ...</span></span>
<span><span class="co">#&gt;   ..$ Zaire    : chr [1:38] "ZL21-203" "ZL21-204" "ZL21-209" "ZL21-218" ...</span></span>
<span><span class="co">#&gt;  $ locus_summary  :List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela :'data.frame':    19 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   .. ..$ patient_id       : chr [1:19] "BD21-002" "BD21-040" "BD21-041" "BD21-053" ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_d0   : num [1:19] 7 7 7 7 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_df   : num [1:19] 7 7 7 5 7 7 7 7 5 7 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_comparable_loci: num [1:19] 7 7 7 5 7 7 7 7 5 7 ...</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul:'data.frame':    13 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   .. ..$ patient_id       : chr [1:13] "LL21-008" "LL21-010" "LL21-027" "LL21-037" ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_d0   : num [1:13] 7 7 7 7 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_df   : num [1:13] 7 7 2 7 4 6 7 6 5 4 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_comparable_loci: num [1:13] 7 7 2 7 4 6 7 6 5 4 ...</span></span>
<span><span class="co">#&gt;   ..$ Zaire    :'data.frame':    38 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   .. ..$ patient_id       : chr [1:38] "ZL21-203" "ZL21-204" "ZL21-209" "ZL21-218" ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_d0   : num [1:38] 7 7 7 7 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_available_df   : num [1:38] 7 7 7 4 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;   .. ..$ n_comparable_loci: num [1:38] 7 7 7 4 7 7 7 7 7 7 ...</span></span>
<span><span class="co">#&gt;  $ locus_lrs      :List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela : num [1:19, 1:7, 1:150] 3.54e-01 5.16e-08 1.55e+01 1.11 6.67e-17 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul: num [1:13, 1:7, 1:150] 0.00107 7.60857 1 0.02486 2.63464 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   ..$ Zaire    : num [1:38, 1:7, 1:150] 2.43 9.43e-11 6.36e-20 1.00 4.37e-04 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;  $ locus_dists    :List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela : num [1:19, 1:7, 1:150] 2 8 0 0 16 2 0 6 10 6 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul: num [1:13, 1:7, 1:150] 4 0 18 2 0 0 0 0 8 20 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   ..$ Zaire    : num [1:38, 1:7, 1:150] 0 10 18 18 4 2 10 0 10 0 ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. .. ..$ : NULL</span></span>
<span><span class="co">#&gt;  $ locinames      :List of 3</span></span>
<span><span class="co">#&gt;   ..$ Benguela : chr [1:7] "313" "383" "TA1" "POLYA" ...</span></span>
<span><span class="co">#&gt;   ..$ Lunda Sul: chr [1:7] "313" "383" "TA1" "POLYA" ...</span></span>
<span><span class="co">#&gt;   ..$ Zaire    : chr [1:7] "313" "383" "TA1" "POLYA" ...</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; ----------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --- Debug: Names in results$ids ---</span></span>
<span><span class="co">#&gt; [1] "Benguela"  "Lunda Sul" "Zaire"    </span></span>
<span><span class="co">#&gt; --- Debug: Names in results$classifications ---</span></span>
<span><span class="co">#&gt; [1] "Benguela"  "Lunda Sul" "Zaire"    </span></span>
<span><span class="co">#&gt; ----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --- Processing site: 'Benguela' ---</span></span>
<span><span class="co">#&gt; Is site_ids NULL?  FALSE </span></span>
<span><span class="co">#&gt; Length of site_ids:  19 </span></span>
<span><span class="co">#&gt; Is site_probs_matrix NULL?  FALSE </span></span>
<span><span class="co">#&gt; Dimensions of site_probs_matrix:  19x150 </span></span>
<span><span class="co">#&gt; Check passed. Calculating probabilities...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --- Processing site: 'Lunda Sul' ---</span></span>
<span><span class="co">#&gt; Is site_ids NULL?  FALSE </span></span>
<span><span class="co">#&gt; Length of site_ids:  13 </span></span>
<span><span class="co">#&gt; Is site_probs_matrix NULL?  FALSE </span></span>
<span><span class="co">#&gt; Dimensions of site_probs_matrix:  13x150 </span></span>
<span><span class="co">#&gt; Check passed. Calculating probabilities...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --- Processing site: 'Zaire' ---</span></span>
<span><span class="co">#&gt; Is site_ids NULL?  FALSE </span></span>
<span><span class="co">#&gt; Length of site_ids:  38 </span></span>
<span><span class="co">#&gt; Is site_probs_matrix NULL?  FALSE </span></span>
<span><span class="co">#&gt; Dimensions of site_probs_matrix:  38x150 </span></span>
<span><span class="co">#&gt; Check passed. Calculating probabilities...</span></span>
<span><span class="co">#&gt; Summary table saved to: C:\Users\golumo\AppData\Local\Temp\RtmpAzfzSn/MalReBay_tutorial_results/probability_of_recrudescence_summary.csv</span></span>
<span><span class="co">#&gt; Detailed marker-level summary saved to: C:\Users\golumo\AppData\Local\Temp\RtmpAzfzSn/MalReBay_tutorial_results/marker_level_summary.csv</span></span>
<span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="interpreting-the-output">4. Interpreting the Output<a class="anchor" aria-label="anchor" href="#interpreting-the-output"></a>
</h2>
<p>The <code><a href="../reference/classify_infections.html">classify_infections()</a></code> function returns a list
containing two key data frames: <code>summary</code> and
<code>marker_details</code>.</p>
<div class="section level3">
<h3 id="the-main-summary-table">4.1 The Main Summary Table<a class="anchor" aria-label="anchor" href="#the-main-summary-table"></a>
</h3>
<p>The <code>$summary</code> data frame provides the main result for
each patient. Let’s look at the first few rows.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_df</span> <span class="op">&lt;-</span> <span class="va">classification_summary</span><span class="op">$</span><span class="va">summary</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">summary_df</span><span class="op">)</span>, caption <span class="op">=</span> <span class="st">"Top rows of the classification summary."</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Top rows of the classification summary.</caption>
<colgroup>
<col width="11%">
<col width="12%">
<col width="15%">
<col width="18%">
<col width="18%">
<col width="22%">
</colgroup>
<thead><tr class="header">
<th align="left">Site</th>
<th align="left">Sample.ID</th>
<th align="right">Probability</th>
<th align="right">N_Available_D0</th>
<th align="right">N_Available_DF</th>
<th align="right">N_Comparable_Loci</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Benguela</td>
<td align="left">BD21-002</td>
<td align="right">0.00</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Benguela</td>
<td align="left">BD21-040</td>
<td align="right">0.00</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">Benguela</td>
<td align="left">BD21-041</td>
<td align="right">1.00</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Benguela</td>
<td align="left">BD21-053</td>
<td align="right">0.98</td>
<td align="right">7</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">Benguela</td>
<td align="left">BD21-075</td>
<td align="right">0.00</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Benguela</td>
<td align="left">BD21-099</td>
<td align="right">0.00</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>The columns are: * <strong>Site</strong>: The geographical site of
the sample. * <strong>Sample.ID</strong>: The unique patient identifier.
* <strong>Probability</strong>: The posterior probability that the
infection is a <strong>recrudescence</strong>. A value near 1.0 suggests
recrudescence, while a value near 0.0 suggests reinfection. *
<strong>N_Available_D0 / N_Available_DF</strong>: The number of loci
with genetic data at Day 0 and Day of Failure, respectively. *
<strong>N_Comparable_Loci</strong>: The number of loci with data at
<em>both</em> time points, which is the amount of data used for the
classification.</p>
</div>
<div class="section level3">
<h3 id="detailed-marker-level-results">4.2 Detailed Marker-Level Results<a class="anchor" aria-label="anchor" href="#detailed-marker-level-results"></a>
</h3>
<p>The <code>$marker_details</code> data frame provides locus-specific
insights, which can be useful for diagnosing which markers are driving a
classification towards reinfection or recrudescence.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">marker_details_df</span> <span class="op">&lt;-</span> <span class="va">classification_summary</span><span class="op">$</span><span class="va">marker_details</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">marker_details_df</span><span class="op">)</span>, caption <span class="op">=</span> <span class="st">"Top rows of the marker-level summary."</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Top rows of the marker-level summary.</caption>
<colgroup>
<col width="11%">
<col width="7%">
<col width="24%">
<col width="15%">
<col width="10%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th align="left">Sample.ID</th>
<th align="left">Marker</th>
<th align="right">Mean_Likelihood_Ratio</th>
<th align="right">Mean_Distance</th>
<th align="left">Site</th>
<th align="left">Interpretation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">BD21-002</td>
<td align="left">313</td>
<td align="right">0.9573058</td>
<td align="right">2.000000</td>
<td align="left">Benguela</td>
<td align="left">Supports Reinfection/Error</td>
</tr>
<tr class="even">
<td align="left">BD21-040</td>
<td align="left">313</td>
<td align="right">0.2899625</td>
<td align="right">7.053333</td>
<td align="left">Benguela</td>
<td align="left">Supports Reinfection/Error</td>
</tr>
<tr class="odd">
<td align="left">BD21-041</td>
<td align="left">313</td>
<td align="right">4.9367155</td>
<td align="right">0.000000</td>
<td align="left">Benguela</td>
<td align="left">Supports Recrudescence</td>
</tr>
<tr class="even">
<td align="left">BD21-053</td>
<td align="left">313</td>
<td align="right">3.7681010</td>
<td align="right">0.040000</td>
<td align="left">Benguela</td>
<td align="left">Supports Recrudescence</td>
</tr>
<tr class="odd">
<td align="left">BD21-075</td>
<td align="left">313</td>
<td align="right">0.0000077</td>
<td align="right">16.000000</td>
<td align="left">Benguela</td>
<td align="left">Supports Reinfection/Error</td>
</tr>
<tr class="even">
<td align="left">BD21-099</td>
<td align="left">313</td>
<td align="right">0.5019277</td>
<td align="right">7.280000</td>
<td align="left">Benguela</td>
<td align="left">Supports Reinfection/Error</td>
</tr>
</tbody>
</table>
<p>This table shows the average likelihood ratio and genetic distance
for each marker for each patient, which can help identify potential
genotyping errors or unusual genetic patterns.</p>
</div>
</div>
<div class="section level2">
<h2 id="visualizing-the-results">5. Visualizing the Results<a class="anchor" aria-label="anchor" href="#visualizing-the-results"></a>
</h2>
<p>A histogram of the posterior probabilities is an excellent way to
visualize the overall results. A clear separation into two groups (one
near 0 and one near 1) indicates high confidence in the
classifications.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">summary_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Probability</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.05</span>, fill <span class="op">=</span> <span class="st">"steelblue"</span>, color <span class="op">=</span> <span class="st">"white"</span>, boundary <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Distribution of Posterior Probabilities of Recrudescence"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Posterior Probability"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Number of Patients"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="MalReBay_files/figure-html/plot-histogram-1.png" width="700"></p>
<p class="caption">
This histogram shows the distribution of posterior probabilities. In
this example run, we see a clear group of patients with low probability
(likely reinfections) and another group with high probability (likely
recrudescences).
</p>
</div>
<div class="section level2">
<h2 id="marker-descriptive-analysis">6. Marker descriptive analysis<a class="anchor" aria-label="anchor" href="#marker-descriptive-analysis"></a>
</h2>
<p>The visualizing the allele frequency distributions helps us
understand the genetic diversity of the markers and can reveal potential
issues or interesting patterns in the data. The following code chunk
will only run if the detected data type is
<code>length_polymorphic</code>, as these frequency plots are most
informative for numeric allele lengths. It uses the internal helper
function <code>generate_allele_frequency_plot</code> to create two sets
of plots, Site-Specific Plots and Overall Plot.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imported_data</span> <span class="op">&lt;-</span> <span class="fu">MalReBay</span><span class="fu">:::</span><span class="fu">import_data</span><span class="op">(</span>filepath <span class="op">=</span> <span class="va">input_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; INFO: Detected 'length_polymorphic' data format.</span></span>
<span><span class="co">#&gt; INFO: Following length-polymorphic data processing pipeline.</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">imported_data</span><span class="op">$</span><span class="va">data_type</span> <span class="op">==</span> <span class="st">"length_polymorphic"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># OVERALL plot</span></span>
<span>  <span class="va">overall_plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span>, <span class="va">imported_data</span><span class="op">$</span><span class="va">additional</span><span class="op">)</span></span>
<span>  <span class="fu">MalReBay</span><span class="fu">:::</span><span class="fu"><a href="../reference/generate_allele_frequency_plot.html">generate_allele_frequency_plot</a></span><span class="op">(</span></span>
<span>    raw_data_df   <span class="op">=</span> <span class="va">overall_plot_data</span>,</span>
<span>    site_name     <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>    output_folder <span class="op">=</span> <span class="va">output_dir</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Site-specific plots</span></span>
<span>  <span class="va">site_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span><span class="op">$</span><span class="va">Site</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">site_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">site_data</span> <span class="op">&lt;-</span> <span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span><span class="op">[</span><span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span><span class="op">$</span><span class="va">Site</span> <span class="op">==</span> <span class="va">site</span>, <span class="op">]</span></span>
<span>    <span class="va">additional_site_data</span> <span class="op">&lt;-</span> <span class="va">imported_data</span><span class="op">$</span><span class="va">additional</span><span class="op">[</span><span class="va">imported_data</span><span class="op">$</span><span class="va">additional</span><span class="op">$</span><span class="va">Site</span> <span class="op">==</span> <span class="va">site</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="fu">MalReBay</span><span class="fu">:::</span><span class="fu"><a href="../reference/generate_allele_frequency_plot.html">generate_allele_frequency_plot</a></span><span class="op">(</span></span>
<span>      raw_data_df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">site_data</span>, <span class="va">additional_site_data</span><span class="op">)</span>,</span>
<span>      site_name <span class="op">=</span> <span class="va">site</span>,</span>
<span>      output_folder <span class="op">=</span> <span class="va">output_dir</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Plot saved to: C:\Users\golumo\AppData\Local\Temp\Rtmpo7gvyS/MalReBay_tutorial_results/allele_freq_plot_Overall.pdf</span></span>
<span><span class="co">#&gt; Plot saved to: C:\Users\golumo\AppData\Local\Temp\Rtmpo7gvyS/MalReBay_tutorial_results/allele_freq_plot_Benguela.pdf</span></span>
<span><span class="co">#&gt; Plot saved to: C:\Users\golumo\AppData\Local\Temp\Rtmpo7gvyS/MalReBay_tutorial_results/allele_freq_plot_Lunda_Sul.pdf</span></span>
<span><span class="co">#&gt; Plot saved to: C:\Users\golumo\AppData\Local\Temp\Rtmpo7gvyS/MalReBay_tutorial_results/allele_freq_plot_Zaire.pdf</span></span></code></pre></div>
<p>The resulting PDF files will be saved in the <code>output_dir</code>
we defined earlier. The plots help answer the following questions about
data quality and genetic diversity:</p>
<ul>
<li>“Is marker X highly diverse (many bars) or mostly monomorphic (one
or two bars)?”</li>
<li>“Are there differences in allele distributions between Day 0 and Day
of Failure?”</li>
<li>“Does the genetic diversity in Site A differ significantly from Site
B?”</li>
</ul>
</div>
<div class="section level2">
<h2 id="files-saved-to-output-folder">Files Saved to Output Folder<a class="anchor" aria-label="anchor" href="#files-saved-to-output-folder"></a>
</h2>
<p>Remember that <code><a href="../reference/classify_infections.html">classify_infections()</a></code> also saved important
files to the <code>output_folder</code> we defined. These include:</p>
<ol style="list-style-type: decimal">
<li>
<code>probability_of_recrudescence_summary.csv</code>: The main
summary table.</li>
<li>
<code>marker_level_summary.csv</code>: The detailed marker-level
table.</li>
<li>A subfolder named <code>convergence_diagnosis/</code> containing
diagnostic plots (traceplots, Gelman-Rubin plots, etc.) for each site,
which are crucial for verifying that the MCMC model converged
correctly.</li>
</ol>
</div>
<div class="section level2">
<h2 id="alternative-analysis-comparing-mcmc-with-match-counting">7. Alternative Analysis: Comparing MCMC with Match-Counting<a class="anchor" aria-label="anchor" href="#alternative-analysis-comparing-mcmc-with-match-counting"></a>
</h2>
<p>While the Bayesian MCMC framework provides a robust probabilistic
classification, it can be very insightful to compare its results to a
traditional, deterministic <strong>match-counting algorithm</strong> as
it the current method recommended by the WHO for TES. The
<code>MalReBay</code> package includes a utility function
<code>perform_match_counting()</code> that can be used to generate a
comparison table between the MCMC results and the match-counting
results.</p>
<p>Here is the flow of the match-counting analysis: 1. Runs the
<code>perform_match_counting()</code> algorithm on the imported data. 2.
Prepares the MCMC summary table for merging by selecting key columns. 3.
Creates a common patient ID to join the different datasets. 4. Performs
a series of joins to create one wide table containing the original
allele data, the detailed match-counting results, and the final MCMC
probability. 5. Reorders the columns for clarity and saves the final
table to a CSV file.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imported_data</span> <span class="op">&lt;-</span> <span class="fu">MalReBay</span><span class="fu">:::</span><span class="fu">import_data</span><span class="op">(</span>filepath <span class="op">=</span> <span class="va">input_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; INFO: Detected 'length_polymorphic' data format.</span></span>
<span><span class="co">#&gt; INFO: Following length-polymorphic data processing pipeline.</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span></span>
<span><span class="va">match_results_df</span> <span class="op">&lt;-</span> <span class="fu">MalReBay</span><span class="fu">:::</span><span class="fu">perform_match_counting</span><span class="op">(</span></span>
<span>  genotypedata_latefailures <span class="op">=</span> <span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span>, </span>
<span>  marker_info <span class="op">=</span> <span class="va">imported_data</span><span class="op">$</span><span class="va">marker_info</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mcmc_summary_for_merge</span> <span class="op">&lt;-</span> <span class="va">summary_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample.ID"</span>, <span class="st">"Probability"</span>, <span class="st">"N_Comparable_Loci"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_summary_for_merge</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample.ID"</span>, <span class="st">"Prob_Recrudescence"</span>, <span class="st">"N_Comparable_Loci_MCMC"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">alleles_with_patient_id</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">imported_data</span><span class="op">$</span><span class="va">late_failures</span>, </span>
<span>                                         Patient.ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" (Day 0|Day Failure)$"</span>, <span class="st">""</span>, <span class="va">Sample.ID</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_table</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">alleles_with_patient_id</span>, <span class="va">match_results_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Patient.ID"</span> <span class="op">=</span> <span class="st">"Sample.ID"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">final_table</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">final_table</span>, <span class="va">mcmc_summary_for_merge</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample.ID"</span> <span class="op">=</span> <span class="st">"Sample.ID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_table_sorted</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">final_table</span>, <span class="va">Patient.ID</span>, <span class="va">Sample.ID</span><span class="op">)</span></span>
<span><span class="va">id_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample.ID"</span>, <span class="st">"Site"</span><span class="op">)</span></span>
<span><span class="va">original_allele_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"(_allele_\\d+|_\\d+)$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">final_table_sorted</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">analysis_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Number_Matches"</span>, <span class="st">"Number_Loci_Compared"</span>, </span>
<span>                   <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">match_results_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sample.ID"</span>, <span class="st">"Number_Matches"</span>, <span class="st">"Number_Loci_Compared"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="st">"Prob_Recrudescence"</span>, <span class="st">"N_Comparable_Loci_MCMC"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_cols_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id_cols</span>, <span class="va">original_allele_cols</span>, <span class="va">analysis_cols</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">final_table_sorted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_comparison_table</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">final_table_sorted</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">final_cols_order</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"algorithm_classification_comparison_table.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">final_comparison_table</span>, <span class="va">output_path</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, na <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">final_comparison_table</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>, </span>
<span>  caption <span class="op">=</span> <span class="st">"First 12 columns of the final comparison table."</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<caption>First 12 columns of the final comparison table.</caption>
<colgroup>
<col width="23%">
<col width="10%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">Sample.ID</th>
<th align="left">Site</th>
<th align="right">313_1</th>
<th align="right">313_2</th>
<th align="right">313_3</th>
<th align="right">383_1</th>
<th align="right">383_2</th>
<th align="right">383_3</th>
<th align="right">TA1_1</th>
<th align="right">TA1_2</th>
<th align="right">TA1_3</th>
<th align="right">TA1_4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">BD21-002 Day 0</td>
<td align="left">Benguela</td>
<td align="right">248</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">133</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">174</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">BD21-002 Day Failure</td>
<td align="left">Benguela</td>
<td align="right">246</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">123</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">177</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">BD21-040 Day 0</td>
<td align="left">Benguela</td>
<td align="right">230</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">137</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">162</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">BD21-040 Day Failure</td>
<td align="left">Benguela</td>
<td align="right">222</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">123</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">171</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">BD21-041 Day 0</td>
<td align="left">Benguela</td>
<td align="right">238</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">123</td>
<td align="right">139</td>
<td align="right">NA</td>
<td align="right">177</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">BD21-041 Day Failure</td>
<td align="left">Benguela</td>
<td align="right">238</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">123</td>
<td align="right">141</td>
<td align="right">NA</td>
<td align="right">177</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>The final table contains the following columns: * The raw allele data
for each marker. * The summary of the match-counting algorithm
(<code>Number_Matches</code>, <code>Number_Loci_Compared</code>). * The
detailed per-locus result of the match-counting (<code>R</code> for
match, <code>NI</code> for non-match, <code>IND</code> for
indeterminate). * The final posterior probability of recrudescence from
the Bayesian MCMC analysis (<code>Prob_Recrudescence</code>).</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This tutorial has shown the main workflow of the
<code>MalReBay</code> package. By using the
<code><a href="../reference/classify_infections.html">classify_infections()</a></code> function, you can efficiently analyze
your genotyping data and obtain robust, probability-based
classifications of recurrent malaria infections.</p>
<p>For more details on the function’s arguments and the underlying
model, please consult the help file by running
<code><a href="../reference/classify_infections.html">?classify_infections</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Veronica Adhiambo Ochieng, Mateusz Plucinski, Monica Golumbeanu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
